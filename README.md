# DEVOPS - CSGames 2024
<img src="assets/logo.svg" width="300">

Bienvenue Ã  la compÃ©tition de devops. Cette compÃ©tition a comme but
la mise en pratique de vos connaissances en intÃ©gration continue de systÃ¨mes modulaires.

Avant de dÃ©buter, il est primordiale d'avoir accÃ¨s aux ressources suivantes :
- Votre numÃ©ro d'Ã©quipe.
- Votre nom d'utilisateur d'Ã©quipe, au format : `team{# d'Ã©quipe}@cs2024.one`
- Votre mot de passe d'Ã©quipe.

**Ces informations vous serons fournies suite Ã  votre arrivÃ©e.**

### RÃ¨gles gÃ©nÃ©rales

- Aucune communication (bidirectionnelle) : il est uniquement permis de communiquer avec les membres de votre Ã©quipe.
- Utilisation d'AI gÃ©nÃ©rative interdite (ChatGPT, Copilot, ...) : l'utilisation de ces outils sera considÃ©rÃ©s comme une communication extÃ©rieure.
- Ne pas tenter de nuire Ã  l'infrastructure de la compÃ©tition.

> Note : Les forums d'aide en ligne (Stack overflow, Reddit, ...) ne sont pas considÃ©rÃ© comme de l'aide extÃ©rieur. Leur utilisation est donc permise.
> Vous ne pouvez toutefois pas poser de questions sur ces forums.

En cas de non-respect de ces rÃ¨gles des pÃ©nalitÃ©s seront appliquÃ©s : **perte de point, disqualification**.

## Introduction et objectif
Certains de vos concitoyens sont restÃ© coincÃ©s Ã  l'intÃ©rieur d'un bunker dans un lieu isolÃ© et **entourÃ© d'arbres**! Nous appellerons ce lieu "la jungle".
Votre objectif est de les aider en s'en Ã©chapper. Pour ce faire, vous devez trouver un moyen de communiquer avec eux.

Le bunker dispose d'un seul accÃ¨s rÃ©seau et celui-ci permet uniquement d'accÃ©der Ã  un service dÃ©tenu par une IA capricieuse
qui surveille toutes les requÃªtes. Pour s'Ã©chapper et retrouver la civilisation les habitant de la jungle doivent avoir accÃ¨s aux informations suivantes :

- La mÃ©tÃ©o, les plantes font moins peur quand il fait froid
- Une carte
- Le code d'accÃ¨s de la porte

Vous avez la chance de disposer d'un accÃ¨s complet Ã  internet (sauf ChatGPT ğŸ¤·) et de maniÃ¨re limitÃ©e au cluster contrÃ´lÃ© par l'IA.
Vous pourrez ainsi aider vos concitoyens en leur fournissant les informations dont ils ont besoin!

L'architecture simplifiÃ©e peut Ãªtre rÃ©sumÃ©e par la figure suivante :

![](assets/base-design.svg)

Les habitant de la jungle dispose d'une communication directe Ã  l'IA qui se trouve dans le mÃªme cluster.
Votre Ã©quipe se trouve dans une autre cluster qui n'est pas limitÃ© dans ces requÃªtes extÃ©rieures.
Votre cluster peut communiquer avec l'IA par l'entremise d'un rÃ©seau virtuel (VNET) mis en place entre les deux clusters (cette Ã©tape est dÃ©jÃ  rÃ©alisÃ©e pour vous).

Bien entendu, le compte Azure fournit donne uniquement accÃ¨s Ã  votre cluster (Team cluster).
En dÃ©ployant votre code dans le cluster de votre Ã©quipe, vous serez en mesure d'interagir avec la jungle.

Les Ã©tapes Ã  rÃ©aliser afin d'accomplir votre mission sont listÃ©s dans [Ã‰preuves](#Ã©preuves).
Le [guide de dÃ©part](#guide-de-dÃ©part) dÃ©crit la configuration requise pour complÃ©ter les Ã©preuves.

Bonne chance!

## Guide de dÃ©part

Cette section dÃ©tails installation des dÃ©pendances requises.

Bien que cette compÃ©tition puisse Ãªtre rÃ©alisÃ©e sur Windows et MacOS, l'utilisation de Linux est encouragÃ©e.
Sous Windows, il est possible d'utiliser WSL.

Ã‰diteurs recommandÃ©s : VSCode, RustRover (en beta).

Tout d'abord, tentez de vous connecter Ã  Azure avec votre compte d'Ã©quipe Ã  l'adresse suivante : https://portal.azure.com.

### Installation des dÃ©pendances :
- Docker, engin (de prÃ©fÃ©rence) ou desktop : https://docs.docker.com/engine/install/
- AZ shell, facilite l'accÃ¨s au cluster : https://learn.microsoft.com/en-us/cli/azure/install-azure-cli
- Helm, permet de tester localement les charts avant de les dÃ©ployer : https://helm.sh/docs/intro/install/

### DÃ©pendances recommandÃ©es :
- Rust : https://www.rust-lang.org/tools/install
- Clippy, permet le formatage du code source : ``rustup component add clippy``

> Ã€ noter : L'utilisation de rust n'est pas obligatoire, cependant l'Ã©preuve 4.1 nÃ©cessite une puissance de calcul plus Ã©levÃ©e.

## Ã‰preuves
Cette section dÃ©taille les diffÃ©rentes Ã©preuves de la compÃ©tition.

### 1. Code de dÃ©part (5 points)
#### 1.1 Serveur HTTP (1.5 point)
Cette premiÃ¨re Ã©tape est la plus simple. Vous devez mettre en place un serveur http permanent d'obtenir le status de votre service (health check).
L'adresse n'est pas trÃ¨s importante (ex. /health).

#### 1.2 Conteneur Docker (3.5 points)
Vous souhaitez conteneuriser votre implÃ©mentation afin de la dÃ©ployer plus facilement. Une coquille de Dockerfile est fournie.

N'oubliez pas de :
- Permettre l'ouverture des ports nÃ©cessaire pour que votre serveur fonctionne
- SÃ©parer votre Dockerfile en plusieurs sections (compilation, exÃ©cution, ...)
- Utiliser des images de base sÃ©curitaires et de petite taille

### 2. DÃ©ploiement (6 points)
Cette section dÃ©cris les Ã©tapes nÃ©cessaires afin de dÃ©ployer votre conteneur de la section prÃ©cÃ©dente sur votre cluster.

#### 2.1 Helm (2 points)
Vous devez crÃ©er des charts helm permettant de dÃ©ployer votre conteneur sur un cluster Kubernetes.

Les charts doivent permettre de :
- DÃ©ployer votre service Ã  partir du ACR (Azure Container Registry) mis Ã  votre disposition (l'image sera y sera poussÃ©e en 2.2).
- Ajouter un service kubernetes permettant d'accÃ©der Ã  votre pod.
- Ajouter un Ingress permettant d'accÃ©der Ã  votre service depuis l'extÃ©rieur et ainsi intÃ©ragir avec ce dernier.
- Ajouter un Service permettant Ã  l'autre cluster (celui de l'IA) d'accÃ©der au vÃ´tre.

L'autre cluster tentera d'accÃ©der au vÃ´tre Ã  adresse : 10.30.10.10.
Le service permettant l'accÃ¨s Ã  votre pod Ã  partir de l'autre cluster est similaire Ã  celui fournit. Il est toutefois conseillÃ© de jeter un coup d'Å“il aux annotations suivantes :
```yml
service.beta.kubernetes.io/azure-load-balancer-ipv4: TODO
service.beta.kubernetes.io/azure-load-balancer-internal: TODO
```

Un exemple de chart helm est fourni. Vous pouvez Ã©galement recrÃ©er un template de charts avec la commande ``helm create NAME_OF_PROJECT``.

#### 2.2 Azure (2 point)
Lors de cette Ã©tape, vous devez crÃ©er une image de votre service, pousser cette image sur l'ACR et dÃ©ployer votre service Ã  l'aide des charts de l'Ã©tape prÃ©cÃ©dente.

Ici, l'objectif n'est pas de dÃ©ployer Ã  partir de Gitlab, mais bien Ã  partir de votre ordinateur afin de valider que ce que vous avez fait jusqu'Ã  prÃ©sent est bien fonctionnel.

Les variables nÃ©cÃ©ssaires au dÃ©ploiement sont les suivantes :
- Votre nom d'utilisateur Azure
- Votre mot de passe Azure
- Le TenantId (vous devez le retrouver Ã  partir du portail en ligne au de AZ shell)
- Le nom de l'ACR
- Le nom du Ressource Group
- Le nom du cluster
- Le nom du domaine : team{# d'Ã©quipe}.dev.cs2024.one

L'ensemble de ces Ã©tapes doivent Ãªtre scriptÃ© afin d'Ãªtre facilement reproductibles. Vous devez vous rÃ©fÃ©rer Ã  la documentation de Helm et Azure cli.

> Ã€ noter : Un exemple de script (``deploy-aks.sh``) vous est fournis. Vous pouvez partir de lÃ  pour cette Ã©tape.

#### 2.3 Pipeline Gitlab (2 points)
Ã€ partir des Ã©tapes de la section 2.2 vous devez automatiser le dÃ©ploiement par l'entremise d'un pipeline Gitlab.

Le pipeline doit permettre de :
- Compiler le code.
- VÃ©rifier la structure du code (lint). Peut Ãªtre rÃ©alisÃ© avec Clippy si Rust est utilisÃ©.
- DÃ©ployer sur le cluster AKS (Azure Kubernetes Cluster).

Les deux premiÃ¨res Ã©tapes vous sont laissÃ©es. Pour la derniÃ¨re, voici quelques suggestions :
- GÃ©nÃ©rer l'image docker Ã  partir du pipeline.
- RÃ©utiliser le script de l'Ã©tape prÃ©cÃ©dente afin de pousser l'image sur l'ACR et dÃ©ployer les charts helm.
- Placer les informations nÃ©cessaires au dÃ©ploiement en variable d'environnement dans les configurations de votre dÃ©pÃ´t Gitlab.
- Utiliser sur docker-in-docker (dind). Les pipelines Gitlab Ã©tant conteneurisÃ© par dÃ©faut, dind est trÃ¨s utile afin de permettre l'utilisation de Docker Ã  partir du pipeline.

Exemple pour docker-in-docker :
```yml
JOB_NAME:
  stage: STAGE_NAME
  image: brqu/docker-az:latest # Or docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker info
...
```

> L'image ``brqu/docker-az:latest`` est basÃ©e sur ``docker:24.0.5`` et contient en plus helm et AZ shell. En l'utilisant, vous n'aurez pas besoin d'installer ces outils Ã  chaque dÃ©ploiement et accÃ©lÃ¨rerez ainsi votre pipeline.

> Pour vous connecter Ã  Azure Ã  partir du pipeline vous devrez utiliser ``az login`` avec votre nom d'utilisateur et votre mot de passe.

### 3. AccÃ©der Ã  la jungle (2 points)
Dans cette Ã©tape, vous devez accÃ©der Ã  la page de status sur service des prisonniers de la jungle. Pour ce faire, vous devez faire une requÃªte http GET Ã  l'adresse suivante Ã  partir de votre service :
- http://ai.private.dev.cs2024.one/jungle

L'information est retournÃ©e dans le corps (_body_) de la rÃ©ponse en JSON. Il s'agit d'une liste de ``Step``. Un ``Step`` est dÃ©finie selon le format suivant :
```typescript
interface Step {
    name: string;
    status: string;
}
```

Vous devez pouvoir accÃ©der Ã  l'information retournÃ©e par cette requÃªte en effectuant une requÃªte Ã  votre propre service.

### 4. LibÃ©rer les prisonniers (6 points)
L'objectif de cette section est de fournir les informations nÃ©cessaires au service des prisonniers afin qu'ils puissent se libÃ©rer.

#### 4.1 Fournir un accÃ¨s (1 point)
Afin d'accomplir les Ã©tapes qui suivent, il est nÃ©cessaire que les prisonniers de la jungle soient en mesure de communiquer avec votre Ã©quipe.
Pour ce faire, ils effectueront des requÃªtes Ã  travers l'IA qui seront redirigÃ©s vers votre cluster.

Les requÃªtes seront des ``POST`` vers le chemin suivant : ``/router``.

Chaque requÃªte contient un paramÃ¨tre (_query parameter_) : ``request``. Ce paramÃ¨tre permet d'indiquer le type de requÃªte en provenance de la jungle.
Le corps (_body_) de la requÃªte contient de l'information sÃ©rialisÃ©e au format _JSON_ spÃ©cifique Ã  chaque requÃªte.

Afin de valider que vous Ãªtes bien en mesure de recevoir les requÃªtes de la jungle, il suffit d'Ã©couter Ã  l'address ``/router`` des requÃªtes ayant comme paramÃ¨tre ``?request=status``.
Pour indiquer que le message est bien reÃ§u, il suffit de rÃ©pondre Ã  la requÃªte avec un code d'erreur dans les 200.

#### 4.2 MÃ©tÃ©o (1.5 point)
Afin de s'Ã©chapper de leur bunker, les prisoners doivent avoir accÃ¨s aux conditions mÃ©tÃ©os. En effet, les plantes aiment beaucoup la chaleur, ils vont donc s'Ã©chapper lorsqu'il fait plus froid.

Afin d'obtenir d'obtenir les informations mÃ©tÃ©o, les prisonniers vont rÃ©aliser une requÃªte vers le chemin ``/router?request=weather``.

Le corps de la requÃªte contiendra les coordonnÃ©es du lieu dont ils souhaitent obtenir la mÃ©tÃ©o. Le _payload_ est au format _JSON_ suivant :
```typescript
interface Coords {
    x: number; // latitude
    y: number; // longitude
}
```

Vous devez retourner les informations mÃ©tÃ©o (en rÃ©ponse Ã  la requÃªte) au format JSON suivant :
```typescript
export interface Weather {
    temperature: number; // Celcius
    windSpeed: number; // Km/h
    precipitation: number; // mm
}
```

> Afin d'obtenir les informations mÃ©tÃ©o, il est suggÃ©rÃ© d'utiliser l'API suivante : https://api.open-meteo.com.
> Si vous utilisez une autre API, les rÃ©sults seront considÃ©rÃ©s valides si les prÃ©cipitations et la tempÃ©rature sont similaires (5mm, 5Â°c).

#### 4.3 Carte (2 points)
Afin de sortir de leur bunker, les prisonniers doivent avoir accÃ¨s Ã  la carte de la jungle. Cette carte prend la forme d'un conteneur docker.

Image de la carte : ``brqu/jungle-map``.

Ce conteneur doit Ãªtre dÃ©ployÃ© sur le mÃªme cluster que votre conteneur.

> Ã€ noter : Il est fortement conseiller d'effectuer le dÃ©ploiement avec helm (voir ``helm init``).

Les requÃªtes en provenance de la jungle (vers ``/router``) auront comme paramÃ¨tre ``request=map``.
Le payload du _body_ sera au format suivant :
```typescript
interface MapRequest {
    x: number, // latitude, float
    y: number, // longitude, float
    size: number, // map size, positive integer
}
```

Afin d'obtenir une carte Ã  partir de ce conteneur, il est possible d'effectuer une requÃªte ``POST`` Ã  ``/``.
Les paramÃ¨tres sont des _query parameters_ portant les mÃªmes noms que les attributs de l'interface ``MapRequest``. Par exemple :

```
http://[MAP_CONTAINER_URL]/?x=75.653&y=-45.6534&size=3
```

Le conteneur fournit alors une rÃ©ponse en ``JSON`` suivant le format suivant :

```typescript
SIZE = ...
interface MapResponse {
    map: number[SIZE][SIZE]; // Matrix of intergers
}
```

Cette information peut Ãªtre directement retournÃ©e Ã  la requÃªte (sur ``/router``) car le format de rÃ©ponse est le mÃªme!

Si cette Ã©tape est concluante, la page de status (http://ai.private.dev.cs2024.one/jungle) devrait Ãªtre mise Ã  jour aprÃ¨s environ une minute.

#### 4.4 Fournir aux prisoners mot de passe de la porte (1.5 point)
Maintenant que les prisoners ont accÃ¨s Ã  la mÃ©tÃ©o et Ã  la carte, il ne reste plus qu'Ã  leur donner le mot de passe de la porte qui les sÃ©parent du monde extÃ©rieur.

Heureusement pour eux, les mots de passes choisis par l'IA sont inspirÃ©s de mots de passe rÃ©els qui sont prÃ©sents dans une [liste](https://raw.githubusercontent.com/DavidWittman/wpxmlrpcbrute/master/wordlists/1000-most-common-passwords.txt) bien connue.

Lors qu'il tente d'ouvrir la porte, un mot de passe Ã  usage unique est "gÃ©nÃ©rÃ©" Ã  partir de cette liste et les prisonniers ont trouvÃ© le moyen d'intercepter le hash md5 de ce mot de passe!
Cependant, ils ne disposent pas d'une puissance de calcul suffisante afin de retrouver le bon mot de passe en moins de 500ms. Ils ont donc encore besoin de votre aide.

Les mots de passe hachÃ© seront transmis encodÃ© au format base64 Ã  ``/router?request=door`` dans un _payload_ au format suivant :

```typescript
interface Door {
    hash: string; // base64 encoded md5 hash
}
```

La jungle n'attend pas de rÃ©ponse de cette requÃªte, il suffit de rÃ©pondre avec un code dans les 200.

Vous devez trouver le mot de passe correspond au hash en moins de 500ms et l'envoyer Ã  la jungle.

Afin d'envoyer le mot de passe Ã  la jungle, vous devez effectuer une requÃªte ``POST`` Ã  l'adresse suivante :
```
http://ai.private.dev.cs2024.one/jungle/unlock?password=UNHASHED_PASSWORD
```

Si le mot de passe est correctement retournÃ©, la page de stage de la jungle devrait se mettre Ã  jour en environ une minute.

### 5. Bonus (0.5 points)

OÃ¹ se trouve le bunker ?

> ?

## Ã‰valuation et remise

Les critÃ¨res d'Ã©valuation sont les suivants :

| CritÃ¨res                | Score /20 |
|-------------------------|-----------|
| Code de base et Docker  | /5        |
| DÃ©ploiement             | /6        |
| AccÃ©der Ã  la jungle     | /2        |
| LibÃ©rer les prisonniers | /6        |
| QualitÃ© de la solution  | /1        |

Les quatre premiers critÃ¨res sont dÃ©taillÃ©es dans la section [Ã‰preuves](#Ã©preuves).

Le dernier critÃ¨re sera Ã©valuÃ© en fonction de la cohÃ©rence gÃ©nÃ©rale de la solution et sera Ã©valuÃ© selon les
critÃ¨res suivants (perte de 1 point au maximum) :
- Aucun linter n'est utilisÃ© : -0.5.
- Aucune convention propre au langage utilisÃ©e n'est respectÃ©e : -0.5.
- Code dupliquÃ© (ex. ne pas utiliser le script de dÃ©ploiement dans le pipeline) : -0.5.
- PrÃ©sence de secrets dans le code (ex. mot de passe) : -0.5.
- Valeurs propres Ã  environment prÃ©sentes directement dans le code (tentez d'utiliser des variables d'environnement) : -0.25.

> Ã€ noter : L'Ã©valuation est partiellement automatisÃ©e, nÃ©anmoins l'ensemble de votre travail sera rÃ©visÃ© manuellement.
> En cas de doute, n'hÃ©sitez pas Ã  indiquer vos suppositions dans la section [Commentaires](#Commentaires) Ã  la fin de ce fichier.

### Remise
- La remise se fait par Git, vous devez soumettre par l'entremise de ce dÃ©pÃ´t tout votre travail
- Le dernier commit poussÃ© sur la branche `main` sera corrigÃ©
- Tout commit poussÃ© aprÃ¨s l'heure de remise sera ignorÃ©

## Commentaires

...
